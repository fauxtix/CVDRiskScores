<?xml version="1.0" encoding="utf-8"?>
<toolkit:Popup
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:resx="clr-namespace:CVDRiskScores.Resources.Languages"
    xmlns:conv="clr-namespace:CVDRiskScores.Converters"
    xmlns:vm="clr-namespace:CVDRiskScores.MVVM.Models.Shared"
    x:Class="CVDRiskScores.MVVM.Views.Shared.SimulationResultPopupGeneric"
    WidthRequest="440"
    HeightRequest="640"
    BackgroundColor="Transparent">

    <toolkit:Popup.Resources>
        <ResourceDictionary>
            <conv:IsBooleanStringConverter x:Key="IsBooleanStringConverter" />
            <conv:BooleanToGlyphConverter x:Key="BooleanToGlyphConverter" />
            <conv:BooleanGlyphColorConverter x:Key="BooleanGlyphColorConverter" />
            <conv:KeyHighlightConverter x:Key="KeyHighlightConverter" />
            <conv:StringToColorConverter x:Key="StringToColorConverter" />
            <conv:IsColorMarkerConverter x:Key="IsColorMarkerConverter" />
        </ResourceDictionary>
    </toolkit:Popup.Resources>

    <Grid Padding="16" RowDefinitions="Auto,*,Auto" ColumnDefinitions="*">
        <!-- Header -->
        <Border x:Name="HeaderBorder" Grid.Row="0" Padding="12" BackgroundColor="{StaticResource Primary}">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12" />
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow Brush="#44000000" Offset="0,4" Radius="8" Opacity="0.25" />
            </Border.Shadow>

            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto">
                <!-- Title -->
                <Label x:Name="TitleLabel" Grid.Row="0" Grid.Column="0" 
                       Text="Resultado" FontSize="18" FontAttributes="Bold" TextColor="White" />

                <!-- Badge (right) -->
                <Border Grid.Row="0" Grid.Column="1" 
                        BackgroundColor="White" 
                        Padding="8" HorizontalOptions="End" 
                        VerticalOptions="Center">
                    <Border.StrokeShape><RoundRectangle CornerRadius="24" /></Border.StrokeShape>
                    <Label x:Name="BadgeLabel" Text="-" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Primary}"
                           HorizontalTextAlignment="Center" VerticalTextAlignment="Center"/>
                </Border>

                <!-- Subtitle plus emoji inline -->
                <HorizontalStackLayout Grid.Row="1" Grid.Column="0" 
                                       Spacing="8" 
                                       VerticalOptions="Center">
                    <Label x:Name="SubtitleLabel"
                           Text=""
                           Margin="0, -10, 0, 0"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="#EAF2FF"
                           VerticalOptions="Center" />
                    <Label x:Name="RiskEmojiLabel"
                           Text=""
                           FontSize="24"
                           IsVisible="False"
                           VerticalOptions="Center"
                           Margin="0,-10,6,0"/>
                </HorizontalStackLayout>

                <!-- Advice: span both columns so it renders fully under the subtitle -->
                <Label x:Name="AdviceLabel"
                       Grid.Row="2"
                       Grid.Column="0"
                       Grid.ColumnSpan="2"
                       Text=""
                       FontSize="12"
                       TextColor="#EAF2FF"
                       Opacity="0.95"
                       LineBreakMode="WordWrap"
                       MaxLines="3"
                       IsVisible="False"
                       HorizontalOptions="Start"
                       VerticalOptions="Center"/>
            </Grid>
        </Border>

        <!-- Details -->
        <Border Grid.Row="1" Margin="0,12,0,12"
                Background="{AppThemeBinding Light={StaticResource WhiteBrush}, Dark={StaticResource Gray950Brush}}">
            <Border.StrokeShape><RoundRectangle CornerRadius="10" /></Border.StrokeShape>

            <Grid RowDefinitions="Auto,*,Auto">
                <!-- subtle guideline -->
                <BoxView WidthRequest="1"
                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray100Brush}, Dark={StaticResource Gray950Brush}}"
                         Opacity="0.45"
                         HorizontalOptions="Start"
                         VerticalOptions="Fill"
                         Margin="24,8,0,8" />

                <CollectionView x:Name="DetailsCollection"
                                Margin="32,8,12,8"
                                ItemsLayout="VerticalList"
                                VerticalScrollBarVisibility="Always"
                                SelectionMode="None"
                                ItemSizingStrategy="MeasureFirstItem"
                                VerticalOptions="Fill"
                                Grid.Row="1">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:KeyValueRow">
                            <Grid ColumnDefinitions="Auto,*" Margin="0,6" VerticalOptions="Center">
                                <Label Text="{Binding Key}"
                                       FontSize="13"
                                       TextColor="{StaticResource Gray500Brush}"
                                       VerticalOptions="Center"
                                       Grid.Column="0"
                                       HorizontalOptions="Start"/>

                                <HorizontalStackLayout Grid.Column="1" HorizontalOptions="End" Spacing="8" VerticalOptions="Center">
                                    <!-- Ellipse for color markers -->
                                    <Ellipse WidthRequest="20" HeightRequest="20"
                                             Fill="{Binding Value, Converter={StaticResource StringToColorConverter}}"
                                             IsVisible="{Binding Value, Converter={StaticResource IsColorMarkerConverter}}"
                                             VerticalOptions="Center"/>

                                    <Label Text="{Binding Value}"
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           LineBreakMode="WordWrap"
                                           MaxLines="10"
                                           VerticalOptions="Center"
                                           HorizontalTextAlignment="End"
                                           TextColor="{Binding Key, Converter={StaticResource KeyHighlightConverter}}">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding Value, Converter={StaticResource IsColorMarkerConverter}}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <Label Text="{Binding Value, Converter={StaticResource BooleanToGlyphConverter}}"
                                           IsVisible="{Binding Value, Converter={StaticResource IsBooleanStringConverter}}"
                                           FontSize="16"
                                           VerticalOptions="Center"
                                           TextColor="{Binding Value, Converter={StaticResource BooleanGlyphColorConverter}}"/>
                                </HorizontalStackLayout>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Diagnostics panel (hidden by default) -->
                <StackLayout x:Name="DiagnosticsPanel" Grid.Row="2" IsVisible="False" Padding="12" Spacing="6" BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray950Brush}}">
                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource Gray100Brush}" Opacity="0.35" />
                    <Label x:Name="DiagnosticsTitleLabel" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray500Brush}" Text="Diagnostics" />
                    <Label x:Name="DiagnosticsLPLabel" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource Gray200}}" LineBreakMode="WordWrap" />
                    <Label x:Name="DiagnosticsS0Label" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource Gray200}}" LineBreakMode="WordWrap" />
                    <Label x:Name="DiagnosticsMeanLPLabel" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource Gray200}}" LineBreakMode="WordWrap" />
                    <Label x:Name="DiagnosticsContribLabel" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource Gray200}}" LineBreakMode="WordWrap" />
                </StackLayout>

            </Grid>
        </Border>

        <Border x:Name="ActionsBorder"
             Grid.Row="2"
             Padding="6"
             Margin="0,10,0,0"
             BackgroundColor="{StaticResource Primary}"
             StrokeShape="RoundRectangle 12">
            <Border.Shadow>
                <Shadow Brush="#44000000" Offset="0,4" Radius="8" Opacity="0.22" />
            </Border.Shadow>
            <FlexLayout
                 Direction="Row"
                 Wrap="Wrap"
                 JustifyContent="SpaceAround"
                 AlignItems="Center"
                 HorizontalOptions="Fill"
                 VerticalOptions="Center">
                 <!-- Voltar -->
                 <Border StrokeShape="RoundRectangle 16"
                     BackgroundColor="Transparent"
                     Stroke="{StaticResource Secondary}"
                     Padding="0"
                     Margin="4"
                     StrokeThickness="1">
                     <Button x:Name="CloseAndBackButton"
                         FontAttributes="Bold"
                         TextColor="Black"
                         FontSize="14"
                         CornerRadius="16"
                         BackgroundColor="Transparent"
                         HorizontalOptions="Fill"
                         Padding="15,6"
                         Clicked="OnCloseAndBackClicked"
                         Text="{resx:Localize Key=TituloVoltar}"/>
                 </Border>
                 <!-- Share -->
                 <Border StrokeShape="RoundRectangle 16"
                     BackgroundColor="Transparent"
                     Stroke="{StaticResource Secondary}"
                     Padding="0"
                     Margin="4"
                     StrokeThickness="1">
                         <Button x:Name="ShareButton"
                         FontAttributes="Bold"
                         TextColor="Black"
                         FontSize="14"
                         CornerRadius="16"
                         BackgroundColor="Transparent"
                         HorizontalOptions="Fill"
                         Padding="15,6"
                         Clicked="OnShareClicked"
                         Text="{resx:Localize Key=TituloPartilhar}"/>
                 </Border>
                 <!-- Copy -->
                 <Border StrokeShape="RoundRectangle 16"
                     BackgroundColor="Transparent"
                     Stroke="{StaticResource Secondary}"
                     Padding="0"
                     Margin="4"
                     StrokeThickness="1">
                         <Button x:Name="CopyButton"
                         FontAttributes="Bold"
                         TextColor="Black"
                         FontSize="14"
                         CornerRadius="16"
                         BackgroundColor="Transparent"
                         HorizontalOptions="Fill"
                         Padding="15,6"
                         Clicked="OnCopyClicked"
                         Text="{resx:Localize Key=Btn_Copy}"/>
                 </Border>
             </FlexLayout>
         </Border>
     </Grid>
 </toolkit:Popup>